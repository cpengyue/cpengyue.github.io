<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="apple-touch-icon-precomposed" href="./app/img/favicon.png">
  <link rel="shortcut icon" href="./app/img/favicon.ico">
  <title>第一次建站</title>
  <script src="./app/js/third/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="./app/js/third/bmobSocketIo.js"></script>
  <script type="text/javascript" src="./app/js/third/bmob.js"></script>
  
</head>
<body>
  <p>你是第<span class="viewTimes"></span>个访问者</p>
  <h1>chat room demo</h1>
    <div id="data"></div>
    <div>
        昵称<input type="text" id="name"/>
        内容<input type="text" id="content"/>
        <button name="发送" id="send">发送
    </div>

  
  <script src="./app/js/index.js" type="text/javascript"></script>
  <script>
    function sendMsg(){

        var name= $("#name").val();
        var content = $("#content").val();

        if($.trim(name)==""){
            alert("昵称不能为空！");
            return;
        }

         if($.trim(content)==""){
            alert("内容不能为空！");
            return;
        }       

        var Chat = Bmob.Object.extend("Chat");
        var chat = new Chat();
        chat.set("name", $("#name").val());
        chat.set("content", $("#content").val());
        chat.save(null, {
            success: function(object) {           
            },
            error: function(model, error) {            
            }
        });     
    }

    $("#send").click(function(){

        sendMsg();
    });

    //服务器
    BmobSocketIo.initialize("3ad33cb8d85d8a3429ae6c1c7da6043d");
    Bmob.initialize("3ad33cb8d85d8a3429ae6c1c7da6043d", "0a40065fb3b94ecd18be728438a70026");
    
   //初始连接socket.io服务器后，需要监听的事件都写在这个函数内
    BmobSocketIo.onInitListen = function() {
        //订阅GameScore表的数据更新事件
        BmobSocketIo.updateTable("Chat");     
    };

      //监听服务器返回的更新表的数据
    BmobSocketIo.onUpdateTable = function(tablename,data) {   
     
        if( tablename=="Chat" ) {
            // alert(tablename);
            var content=$("#data");
            var p = '<p><span style="color:red;">' + data.name+'</span>  '+'<span style="color:green;">'+ data.createdAt+'</span>  '+ ' :<br/> '+data.content+'</p><br/><br/>';
            content.html(content.html()+p);
        }
    };

  //通过“回车”提交聊天信息
    $('#name').keydown(function(e) {
        if (e.keyCode === 13) {
            sendMsg();
        }
    });

  //通过“回车”提交聊天信息
   $('#content').keydown(function(e) {
        if (e.keyCode === 13) {
        sendMsg();
        }
    });
  </script>
</body>
</html>